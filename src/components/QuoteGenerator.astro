---
import { Image } from 'astro:assets';
import marcusImg from '../assets/images/marcus.png';
import epictetusImg from '../assets/images/epictetus.png';
import senecaImg from '../assets/images/seneca.png';

const philosophers = [
  { id: 'marcus', name: 'Marcus Aurelius', title: 'the Emperor', image: marcusImg, glowClass: 'glow-marcus' },
  { id: 'epictetus', name: 'Epictetus', title: 'the Teacher', image: epictetusImg, glowClass: 'glow-epictetus' },
  { id: 'seneca', name: 'Seneca', title: 'the Advisor', image: senecaImg, glowClass: 'glow-seneca' }
];
---

<div class="h-[85vh] md:h-[600px] w-full max-w-lg overflow-y-scroll snap-y snap-mandatory scroll-smooth no-scrollbar border-y border-white/10 mx-auto" id="stoic-scroller">
  {philosophers.map((phil, index) => (
    <section class="h-full w-full flex flex-col items-center justify-start md:justify-center snap-start py-10 md:py-12 relative" data-philosopher={phil.id}>

      <div class="bust-container pt-4 md:pt-0 cursor-pointer transition-all active:scale-95 group shrink-0">
        <Image
          src={phil.image}
          alt={phil.name}
          class={`w-40 md:w-44 h-auto transition-transform group-hover:scale-105 ${phil.glowClass}`}
          width={176}
        />
      </div>

      <p class="mt-4 text-[10px] uppercase tracking-[0.4em] text-white/40 font-black">{phil.name}</p>

      <div class="relative w-full px-6 md:px-10 mt-6 group/quote">

        <button class="copy-btn absolute right-8 md:right-12 top-0 z-20 opacity-0 transition-all p-2 bg-black/20 backdrop-blur-md rounded-lg text-white/50 hover:text-white" title="Copy Quote" aria-label="Copy quote to clipboard">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
        </button>

        <div class="quote-box flex flex-col items-center overflow-y-auto max-h-[200px] md:max-h-[250px] pr-2 stoic-scrollbar">
          <p class="quote-text text-lg md:text-xl text-white font-medium italic leading-relaxed text-center drop-shadow-[0_2px_2px_rgba(0,0,0,0.3)]">
            "Click {phil.title} to begin."
          </p>
          <span class="quote-source block mt-4 text-[10px] uppercase tracking-widest text-white/40 text-center font-bold"></span>
        </div>
      </div>

      <div class="scroll-hint mt-auto mb-4 text-white/20 text-[10px] animate-bounce shrink-0 uppercase tracking-widest">
        {index === 0 ? '↓ swipe' : index === philosophers.length - 1 ? '↑ swipe' : '↑↓'}
      </div>
    </section>
  ))}
</div>

<style is:global>
  .no-scrollbar::-webkit-scrollbar { display: none; }
  .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

  /* Marcus: Clean Pink Outer Glow (No Green) */
  .glow-marcus { filter: drop-shadow(0 0 12px #ff00ff) drop-shadow(0 0 2px #ff00ff); }
  .glow-epictetus { filter: drop-shadow(0 0 15px #00f2ff) hue-rotate(180deg); }
  .glow-seneca { filter: drop-shadow(0 0 15px #ffff00) sepia(0.3); }

  /* Themed Scrollbars for Desktop */
  .stoic-scrollbar::-webkit-scrollbar { width: 4px; }
  .stoic-scrollbar::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.05); border-radius: 10px; }
  .stoic-scrollbar::-webkit-scrollbar-thumb { background: linear-gradient(to bottom, #00f2ff, #ff00ff); border-radius: 10px; }

  /* Desktop/Mobile Visibility Logic */
  @media (hover: hover) {
    .group\/quote:hover .copy-btn { opacity: 1; transform: translateY(-5px); }
  }
  .copy-btn.visible { opacity: 0.8 !important; transform: translateY(0); }

  .quote-box { transition: opacity 0.4s ease-in-out; }
</style>

<script>
  const sources = {
    marcus: { url: '/assets/stoa/meditations.json', format: (q) => `— Meditations, Book ${q.book}, Verse ${q.verse}` },
    epictetus: { url: '/assets/stoa/epictetus.json', format: (q) => `— ${q.work || 'Discourses'}, ${q.chapter || q.section || ''}` },
    seneca: { url: '/assets/stoa/seneca.json', format: (q) => `— ${q.work || 'Letters'}, ${q.letter ? `Letter ${q.letter}` : q.chapter || ''}` }
  };

  const data = {};
  const isTouch = window.matchMedia("(pointer: coarse)").matches;

  async function init() {
    for (const [key, config] of Object.entries(sources)) {
      try {
        const res = await fetch(config.url);
        if (res.ok) data[key] = await res.json();
      } catch (e) { console.warn(`Load error: ${key}`); }
    }
  }

  const copyIcon = '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>';
  const checkIcon = '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#00f2ff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>';

  document.querySelectorAll('section').forEach(section => {
    const phil = section.getAttribute('data-philosopher');
    const bust = section.querySelector('.bust-container');
    const textEl = section.querySelector('.quote-text');
    const sourceEl = section.querySelector('.quote-source');
    const quoteBox = section.querySelector('.quote-box');
    const copyBtn = section.querySelector('.copy-btn');

    bust?.addEventListener('click', () => {
      const quotes = data[phil];
      if (!quotes?.length) return;

      quoteBox.style.opacity = '0';
      if (isTouch) copyBtn?.classList.remove('visible');

      setTimeout(() => {
        const q = quotes[Math.floor(Math.random() * quotes.length)];
        textEl.innerText = `"${q.english || q.text || q.quote}"`;
        sourceEl.innerText = sources[phil].format(q);
        quoteBox.style.opacity = '1';
        quoteBox.scrollTop = 0; // Reset scroll position for new quote

        if (isTouch) copyBtn?.classList.add('visible');
      }, 400);
    });

    copyBtn?.addEventListener('click', async () => {
      const content = `${textEl.innerText}\n${sourceEl.innerText}`;
      try {
        await navigator.clipboard.writeText(content);
        copyBtn.innerHTML = checkIcon;
        setTimeout(() => copyBtn.innerHTML = copyIcon, 2000);
      } catch (err) { console.error('Copy failed', err); }
    });
  });

  init();
</script>
