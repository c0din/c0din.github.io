---
import { Image } from 'astro:assets';
import marcusImg from '../assets/images/marcus.png';
import epictetusImg from '../assets/images/epictetus.png';
import senecaImg from '../assets/images/seneca.png';

const philosophers = [
  { id: 'marcus', name: 'Marcus Aurelius', title: 'the Emperor', image: marcusImg, glowClass: 'glow-marcus' },
  { id: 'epictetus', name: 'Epictetus', title: 'the Teacher', image: epictetusImg, glowClass: 'glow-epictetus' },
  { id: 'seneca', name: 'Seneca', title: 'the Advisor', image: senecaImg, glowClass: 'glow-seneca' }
];
---

<div class="h-screen w-full overflow-y-scroll snap-y snap-mandatory scroll-smooth no-scrollbar" id="stoic-scroller">
  {philosophers.map((phil, index) => (
    <section class="h-screen w-full flex flex-col items-center justify-center snap-start relative overflow-hidden px-6" data-philosopher={phil.id}>

      <div class="bust-container cursor-pointer transition-all duration-500 active:scale-95 group z-20 mt-[-10vh]">
        <Image
          src={phil.image}
          alt={phil.name}
          class={`w-64 md:w-96 h-auto transition-transform duration-700 group-hover:scale-105 ${phil.glowClass}`}
          width={384}
        />
      </div>

      <p class="mt-8 text-[10px] uppercase tracking-[0.6em] text-slate-900/40 font-bold z-20">{phil.name}</p>

      <div class="relative w-full max-w-3xl mt-12 group/quote z-20">

        <span class="absolute -top-12 -left-4 md:-left-8 text-8xl md:text-9xl font-serif text-slate-900/5 pointer-events-none select-none">"</span>
        <span class="absolute -bottom-12 -right-4 md:-right-8 text-8xl md:text-9xl font-serif text-slate-900/5 pointer-events-none select-none">"</span>

        <button class="copy-btn absolute right-0 -top-8 z-30 opacity-0 transition-all p-2 text-slate-900/30 hover:text-slate-900" title="Copy Quote" aria-label="Copy quote to clipboard">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
        </button>

        <div class="quote-box flex flex-col items-center overflow-y-auto max-h-[35vh] px-4 invisible-scrollbar">
          <p class="quote-text text-2xl md:text-4xl text-slate-900 font-light tracking-tight leading-tight md:leading-snug text-center selection:bg-pink-500/30">
            Click {phil.title} to begin.
          </p>
          <span class="quote-source block mt-6 text-[11px] uppercase tracking-[0.2em] text-slate-900/40 text-center font-medium"></span>
        </div>
      </div>

      <div class="absolute bottom-0 left-0 w-full h-[40vh] bg-gradient-to-t from-white/60 to-transparent pointer-events-none z-10"></div>

      <div class="scroll-hint absolute bottom-8 text-slate-900/20 text-[10px] animate-bounce uppercase tracking-widest font-bold z-20">
        {index === 0 ? '↓ swipe' : index === philosophers.length - 1 ? '↑ swipe' : '↑↓'}
      </div>
    </section>
  ))}
</div>

<style is:global>
  .no-scrollbar::-webkit-scrollbar { display: none; }
  .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

  /* Marcus: Outer Pink Glow */
  .glow-marcus { filter: drop-shadow(0 0 15px rgba(255, 0, 255, 0.6)); }
  .glow-epictetus { filter: drop-shadow(0 0 20px rgba(0, 242, 255, 0.5)) hue-rotate(180deg); }
  .glow-seneca { filter: drop-shadow(0 0 20px rgba(255, 255, 0, 0.4)) sepia(0.3); }

  /* Almost invisible quote scrollbar */
  .invisible-scrollbar::-webkit-scrollbar { width: 2px; }
  .invisible-scrollbar::-webkit-scrollbar-thumb { background: rgba(15, 23, 42, 0.05); }

  .quote-box { transition: opacity 0.4s ease-in-out; }

  @media (hover: hover) {
    .group\/quote:hover .copy-btn { opacity: 1; }
  }
  .copy-btn.visible { opacity: 0.6 !important; }
</style>

<script>
  const sources = {
    marcus: { url: '/assets/stoa/meditations.json', format: (q) => `— Meditations, Book ${q.book}, Verse ${q.verse}` },
    epictetus: { url: '/assets/stoa/epictetus.json', format: (q) => `— ${q.work || 'Discourses'}, ${q.chapter || q.section || ''}` },
    seneca: { url: '/assets/stoa/seneca.json', format: (q) => `— ${q.work || 'Letters'}, ${q.letter ? `Letter ${q.letter}` : q.chapter || ''}` }
  };

  const data = {};
  const isTouch = window.matchMedia("(pointer: coarse)").matches;

  async function init() {
    for (const [key, config] of Object.entries(sources)) {
      try {
        const res = await fetch(config.url);
        if (res.ok) data[key] = await res.json();
      } catch (e) { console.warn(`Load error: ${key}`); }
    }
  }

  const copyIcon = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>';
  const checkIcon = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#0ea5e9" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>';

  document.querySelectorAll('section').forEach(section => {
    const phil = section.getAttribute('data-philosopher');
    const bust = section.querySelector('.bust-container');
    const textEl = section.querySelector('.quote-text');
    const sourceEl = section.querySelector('.quote-source');
    const quoteBox = section.querySelector('.quote-box');
    const copyBtn = section.querySelector('.copy-btn');

    bust?.addEventListener('click', () => {
      const quotes = data[phil];
      if (!quotes?.length) return;

      quoteBox.style.opacity = '0';
      if (isTouch) copyBtn?.classList.remove('visible');

      setTimeout(() => {
        const q = quotes[Math.floor(Math.random() * quotes.length)];
        textEl.innerText = q.english || q.text || q.quote;
        sourceEl.innerText = sources[phil].format(q);
        quoteBox.style.opacity = '1';
        quoteBox.scrollTop = 0;

        if (isTouch) copyBtn?.classList.add('visible');
      }, 400);
    });

    copyBtn?.addEventListener('click', async () => {
      const content = `${textEl.innerText}\n${sourceEl.innerText}`;
      try {
        await navigator.clipboard.writeText(content);
        copyBtn.innerHTML = checkIcon;
        setTimeout(() => copyBtn.innerHTML = copyIcon, 2000);
      } catch (err) { console.error('Copy failed', err); }
    });
  });

  init();
</script>
